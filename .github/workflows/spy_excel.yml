name: Spy on Senior Timetable

on:
  schedule:
    - cron: '0 */6 * * *' # Checks every 6 hours
  workflow_dispatch: # Allows you to click "Run Now" button manually

permissions:
  contents: write
  issues: write

jobs:
  steal-excel-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v3

      - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Hunt and Download Excel Files
        run: |
          # 1. SETUP - Define the folders we want to spy on
          # (Note: Using URL encoding for spaces)
          REPO="codelif/jiit-planner-cdn"
          PATH_62="raw/time_tables/B.Tech%2062%20(btech-62)/2"
          PATH_128="raw/time_tables/B.Tech%20128%20(btech-128)/2"
          
          mkdir -p downloaded_excels

          # Function to find and download the first .xlsx file in a folder
          download_from_folder() {
            FOLDER_PATH=$1
            SAVE_NAME=$2
            
            echo "üîç Looking in $FOLDER_PATH..."
            
            # Get list of files via API
            RESPONSE=$(curl -s "https://api.github.com/repos/$REPO/contents/$FOLDER_PATH")
            
            # Extract the download URL for the first .xlsx file found
            DOWNLOAD_URL=$(echo "$RESPONSE" | grep -o '"download_url": "[^"]*"' | grep ".xlsx" | head -n 1 | cut -d'"' -f4)
            
            if [ -z "$DOWNLOAD_URL" ]; then
              echo "‚ùå No Excel file found in $FOLDER_PATH"
            else
              echo "‚úÖ Found file! Downloading from: $DOWNLOAD_URL"
              curl -L -o "downloaded_excels/$SAVE_NAME.xlsx" "$DOWNLOAD_URL"
            fi
          }

          # 2. EXECUTE - Download both files
          download_from_folder "$PATH_62" "Batch_62_Schedule"
          download_from_folder "$PATH_128" "Batch_128_Schedule"

      - name: üíæ Check for Changes & Notify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if git detects any changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "üö® CHANGES DETECTED! Updating repo..."
            
            # Configure Git
            git config --global user.name 'Timetable Spy Bot'
            git config --global user.email 'bot@noreply.github.com'
            
            # Add and Commit
            git add downloaded_excels/*.xlsx
            git commit -m "üî• New Excel Drop detected from Senior Repo"
            git push

            # NOTIFICATION: Create an Issue to alert you
            gh issue create \
              --title "üö® URGENT: Timetable Excel Updated!" \
              --body "The spy bot detected a change in the senior excel sheets. \n\nGo check the 'downloaded_excels' folder in this repo and look for RED fonts."
              
          else
            echo "üò¥ No changes detected. Going back to sleep."
          fi
